# annotations

Today I learned a bit about Java annotations over here

https://www.javatpoint.com/java-annotation

It was good to learn it. I'm planning to try it out now.

So I'm creating my own custom annotation called MyCustomAnnotation.
I have two methods in it - one has a default value, another doesn't.
I'm using this annotation in a class called Example class and when
we don't give a value to the method with no default value, compiler
throws error like this -

```bash
$ gradle build

> Task :compileJava FAILED
/Users/karuppiahn/oss/github.com/karuppiah7890/java-stuff/annotations/src/main/java/annotations/Example.java:3: error: annotation @MyCustomAnnotation is missing a default value for the element 'someBooleanValueWithNoDefault'
@MyCustomAnnotation()
^
1 error

FAILURE: Build failed with an exception.

* What went wrong:
Execution failed for task ':compileJava'.
> Compilation failed; see the compiler error output for details.

* Try:
Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. Run with --scan to get full insights.

* Get more help at https://help.gradle.org

BUILD FAILED in 1s
1 actionable task: 1 executed
```

Wikipedia talks about Java annotation - 

https://en.wikipedia.org/wiki/Java_annotation

```
In the Java computer programming language, an annotation is a form of syntactic metadata
that can be added to Java source code.[1] Classes, methods, variables, parameters and
Java packages may be annotated. Like Javadoc tags, Java annotations can be read from
source files. Unlike Javadoc tags, Java annotations can also be embedded in and read
from Java class files generated by the Java compiler. This allows annotations to be
retained by the Java virtual machine at run-time and read via reflection.[2]
It is possible to create meta-annotations out of the existing ones in Java.[3]
```

So it's just metadata, but it has syntax - so metadata has to be given in some
proper format / syntax and compiler can check the syntax. It can be added
to different kinds of things - classes, methods and what not. I'm going to
try them one by one.

This metadata can be read from source files it seems. So, it's not simply
storing information, but also reading and using that information :) 

For the above error, when I give a value `false`, it tells this error

```bash
$ gradle build

> Task :compileJava FAILED
/Users/karuppiahn/oss/github.com/karuppiah7890/java-stuff/annotations/src/main/java/annotations/Example.java:3: error: cannot find symbol
@MyCustomAnnotation(false)
                    ^
  symbol:   method value()
  location: @interface MyCustomAnnotation
/Users/karuppiahn/oss/github.com/karuppiah7890/java-stuff/annotations/src/main/java/annotations/Example.java:3: error: annotation @MyCustomAnnotation is missing a default value for the element 'someBooleanValueWithNoDefault'
@MyCustomAnnotation(false)
^
2 errors

FAILURE: Build failed with an exception.

* What went wrong:
Execution failed for task ':compileJava'.
> Compilation failed; see the compiler error output for details.

* Try:
Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. Run with --scan to get full insights.

* Get more help at https://help.gradle.org

BUILD FAILED in 832ms
1 actionable task: 1 executed
```

So, it's looking for a method named `value` in the annotation. Looks like that's the default
it considers when we give no name along with the value.

It works once we do this

```java
package annotations;

@MyCustomAnnotation(someBooleanValueWithNoDefault = false)
public class Example {
}
```

I'm going to use this `Example` class in a test method and see if I can read
the metadata that I just defined

I tried to use it but I got a null pointer exception to get the value out
of the annotation which I got from the class. I also got a warning from
Intellij. The error told that annotation class is not retained for
reflective access.

https://www.javatpoint.com/java-annotation has some references to
something called @Retention built in annotation which is used in
other (custom?) annotations. It has three possible values. I'm not
able to understand them yet, but the example code uses the value
`RetentionPolicy.RUNTIME` . I'm going to try to use different
policy values to see when the null pointer exception goes away!
Only with `RetentionPolicy.RUNTIME` it works. 

I just learned a bit more from the points here

https://java2novice.com/java-annotations/retention-policy/

It says that the default is `RetentionPolicy.CLASS`

I also read a bit here

http://tutorials.jenkov.com/java/annotations.html#retention

There's a good example of how to create a simple unit test
framework using custom annotations @Test and @TestInfo

https://mkyong.com/java/java-custom-annotations-example/

It shows how the methods with the annotation @Test are
invoked

A lot of these places talk about "Java Reflection APIs".
It's something I need to learn soon.

One more basic link about annotations is here
http://tutorials.jenkov.com/java-reflection/annotations.html

One more good explanation about retention policies here
https://dzone.com/articles/how-annotations-work-java

The crazy thing is, I'm not able to see the difference
between the three values - SOURCE, CLASS and RUNTIME.

I tried to check the class files, jar file, to see if
the annotation is present in the class file or not and
I see it's always there. Weird.

https://www.jorel.dev/blog/Java-Annotation-Retention-Source

I learned about the `javap` command and tried this out -

```bash
$ # with RetentionPolicy.SOURCE
$ ./gradlew jar
$ javap -v build/classes/java/main/annotations/MyCustomAnnotation.class 
Classfile /Users/karuppiahn/oss/github.com/karuppiah7890/java-stuff/annotations/build/classes/java/main/annotations/MyCustomAnnotation.class
  Last modified Jul 13, 2020; size 426 bytes
  SHA-256 checksum 4f11738bfd7c913631757c7ea4a57a407097c28227ce827095415846f8d6be33
  Compiled from "MyCustomAnnotation.java"
interface annotations.MyCustomAnnotation extends java.lang.annotation.Annotation
  minor version: 0
  major version: 58
  flags: (0x2600) ACC_INTERFACE, ACC_ABSTRACT, ACC_ANNOTATION
  this_class: #1                          // annotations/MyCustomAnnotation
  super_class: #3                         // java/lang/Object
  interfaces: 1, fields: 0, methods: 2, attributes: 2
Constant pool:
   #1 = Class              #2             // annotations/MyCustomAnnotation
   #2 = Utf8               annotations/MyCustomAnnotation
   #3 = Class              #4             // java/lang/Object
   #4 = Utf8               java/lang/Object
   #5 = Class              #6             // java/lang/annotation/Annotation
   #6 = Utf8               java/lang/annotation/Annotation
   #7 = Utf8               someBooleanValueWithDefault
   #8 = Utf8               ()Z
   #9 = Utf8               AnnotationDefault
  #10 = Integer            1
  #11 = Utf8               someBooleanValueWithNoDefault
  #12 = Utf8               SourceFile
  #13 = Utf8               MyCustomAnnotation.java
  #14 = Utf8               RuntimeVisibleAnnotations
  #15 = Utf8               Ljava/lang/annotation/Retention;
  #16 = Utf8               value
  #17 = Utf8               Ljava/lang/annotation/RetentionPolicy;
  #18 = Utf8               SOURCE
{
  public abstract boolean someBooleanValueWithDefault();
    descriptor: ()Z
    flags: (0x0401) ACC_PUBLIC, ACC_ABSTRACT
    AnnotationDefault:
      default_value: Z#10
        true

  public abstract boolean someBooleanValueWithNoDefault();
    descriptor: ()Z
    flags: (0x0401) ACC_PUBLIC, ACC_ABSTRACT
}
SourceFile: "MyCustomAnnotation.java"
RuntimeVisibleAnnotations:
  0: #15(#16=e#17.#18)
    java.lang.annotation.Retention(
      value=Ljava/lang/annotation/RetentionPolicy;.SOURCE
    )

$ javap -v build/classes/java/main/annotations/Example.class 
Classfile /Users/karuppiahn/oss/github.com/karuppiah7890/java-stuff/annotations/build/classes/java/main/annotations/Example.class
  Last modified Jul 13, 2020; size 270 bytes
  SHA-256 checksum 9559c9e64fb60b023c4d3f58f9225003d6546b1012df9300353018f712c1079a
  Compiled from "Example.java"
public class annotations.Example
  minor version: 0
  major version: 58
  flags: (0x0021) ACC_PUBLIC, ACC_SUPER
  this_class: #7                          // annotations/Example
  super_class: #2                         // java/lang/Object
  interfaces: 0, fields: 0, methods: 1, attributes: 1
Constant pool:
   #1 = Methodref          #2.#3          // java/lang/Object."<init>":()V
   #2 = Class              #4             // java/lang/Object
   #3 = NameAndType        #5:#6          // "<init>":()V
   #4 = Utf8               java/lang/Object
   #5 = Utf8               <init>
   #6 = Utf8               ()V
   #7 = Class              #8             // annotations/Example
   #8 = Utf8               annotations/Example
   #9 = Utf8               Code
  #10 = Utf8               LineNumberTable
  #11 = Utf8               LocalVariableTable
  #12 = Utf8               this
  #13 = Utf8               Lannotations/Example;
  #14 = Utf8               SourceFile
  #15 = Utf8               Example.java
{
  public annotations.Example();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: return
      LineNumberTable:
        line 4: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lannotations/Example;
}
SourceFile: "Example.java"
```

In the `Example` class information, there's no information on the
annotations. In annotation class information, you can see that
the retention is `SOURCE`. 

Let's check for `CLASS` and `RUNTIME`

```bash
$ # with RetentionPolicy.CLASS
$ ./gradlew jar
$ javap -v build/classes/java/main/annotations/MyCustomAnnotation.class 
Classfile /Users/karuppiahn/oss/github.com/karuppiah7890/java-stuff/annotations/build/classes/java/main/annotations/MyCustomAnnotation.class
  Last modified Jul 13, 2020; size 425 bytes
  SHA-256 checksum 56ef13448843a815c91b12c52b682a9eae0905e18cba4640c965814e7184b62f
  Compiled from "MyCustomAnnotation.java"
interface annotations.MyCustomAnnotation extends java.lang.annotation.Annotation
  minor version: 0
  major version: 58
  flags: (0x2600) ACC_INTERFACE, ACC_ABSTRACT, ACC_ANNOTATION
  this_class: #1                          // annotations/MyCustomAnnotation
  super_class: #3                         // java/lang/Object
  interfaces: 1, fields: 0, methods: 2, attributes: 2
Constant pool:
   #1 = Class              #2             // annotations/MyCustomAnnotation
   #2 = Utf8               annotations/MyCustomAnnotation
   #3 = Class              #4             // java/lang/Object
   #4 = Utf8               java/lang/Object
   #5 = Class              #6             // java/lang/annotation/Annotation
   #6 = Utf8               java/lang/annotation/Annotation
   #7 = Utf8               someBooleanValueWithDefault
   #8 = Utf8               ()Z
   #9 = Utf8               AnnotationDefault
  #10 = Integer            1
  #11 = Utf8               someBooleanValueWithNoDefault
  #12 = Utf8               SourceFile
  #13 = Utf8               MyCustomAnnotation.java
  #14 = Utf8               RuntimeVisibleAnnotations
  #15 = Utf8               Ljava/lang/annotation/Retention;
  #16 = Utf8               value
  #17 = Utf8               Ljava/lang/annotation/RetentionPolicy;
  #18 = Utf8               CLASS
{
  public abstract boolean someBooleanValueWithDefault();
    descriptor: ()Z
    flags: (0x0401) ACC_PUBLIC, ACC_ABSTRACT
    AnnotationDefault:
      default_value: Z#10
        true

  public abstract boolean someBooleanValueWithNoDefault();
    descriptor: ()Z
    flags: (0x0401) ACC_PUBLIC, ACC_ABSTRACT
}
SourceFile: "MyCustomAnnotation.java"
RuntimeVisibleAnnotations:
  0: #15(#16=e#17.#18)
    java.lang.annotation.Retention(
      value=Ljava/lang/annotation/RetentionPolicy;.CLASS
    )

$ javap -v build/classes/java/main/annotations/Example.class 
Classfile /Users/karuppiahn/oss/github.com/karuppiah7890/java-stuff/annotations/build/classes/java/main/annotations/Example.class
  Last modified Jul 13, 2020; size 389 bytes
  SHA-256 checksum a636914d6da2ecaaf3b5f3e250b64b1c21ac346b3d63c1df536f6332a8aa3d0a
  Compiled from "Example.java"
public class annotations.Example
  minor version: 0
  major version: 58
  flags: (0x0021) ACC_PUBLIC, ACC_SUPER
  this_class: #7                          // annotations/Example
  super_class: #2                         // java/lang/Object
  interfaces: 0, fields: 0, methods: 1, attributes: 2
Constant pool:
   #1 = Methodref          #2.#3          // java/lang/Object."<init>":()V
   #2 = Class              #4             // java/lang/Object
   #3 = NameAndType        #5:#6          // "<init>":()V
   #4 = Utf8               java/lang/Object
   #5 = Utf8               <init>
   #6 = Utf8               ()V
   #7 = Class              #8             // annotations/Example
   #8 = Utf8               annotations/Example
   #9 = Utf8               Code
  #10 = Utf8               LineNumberTable
  #11 = Utf8               LocalVariableTable
  #12 = Utf8               this
  #13 = Utf8               Lannotations/Example;
  #14 = Utf8               SourceFile
  #15 = Utf8               Example.java
  #16 = Utf8               RuntimeInvisibleAnnotations
  #17 = Utf8               Lannotations/MyCustomAnnotation;
  #18 = Utf8               someBooleanValueWithNoDefault
  #19 = Integer            0
{
  public annotations.Example();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: return
      LineNumberTable:
        line 4: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lannotations/Example;
}
SourceFile: "Example.java"
RuntimeInvisibleAnnotations:
  0: #17(#18=Z#19)
    annotations.MyCustomAnnotation(
      someBooleanValueWithNoDefault=false
    )
```

This time we are able to see the annotations in the `Example` class, but these annotations
won't be available at runtime - they will be discarded when the class loader
loads the classes. If you look closely at the above information, it says "RuntimeInvisibleAnnotations".
Funnily I was reading this as "RuntimeVisibleAnnotations" and thinking how weird it was ðŸ¤£ Anyways,
with that out of the way, it's clear when the program is running - it cannot
read the annotation, or the information provided along with the annotation as elements.

```bash
$ # with RetentionPolicy.RUNTIME
$ ./gradlew jar
$ javap -v build/classes/java/main/annotations/MyCustomAnnotation.class 
Classfile /Users/karuppiahn/oss/github.com/karuppiah7890/java-stuff/annotations/build/classes/java/main/annotations/MyCustomAnnotation.class
  Last modified Jul 13, 2020; size 427 bytes
  SHA-256 checksum 1079208f0f5635110a86fe1a5178537f7e4a16cbb8a54d4180b11d0f0f806f37
  Compiled from "MyCustomAnnotation.java"
interface annotations.MyCustomAnnotation extends java.lang.annotation.Annotation
  minor version: 0
  major version: 58
  flags: (0x2600) ACC_INTERFACE, ACC_ABSTRACT, ACC_ANNOTATION
  this_class: #1                          // annotations/MyCustomAnnotation
  super_class: #3                         // java/lang/Object
  interfaces: 1, fields: 0, methods: 2, attributes: 2
Constant pool:
   #1 = Class              #2             // annotations/MyCustomAnnotation
   #2 = Utf8               annotations/MyCustomAnnotation
   #3 = Class              #4             // java/lang/Object
   #4 = Utf8               java/lang/Object
   #5 = Class              #6             // java/lang/annotation/Annotation
   #6 = Utf8               java/lang/annotation/Annotation
   #7 = Utf8               someBooleanValueWithDefault
   #8 = Utf8               ()Z
   #9 = Utf8               AnnotationDefault
  #10 = Integer            1
  #11 = Utf8               someBooleanValueWithNoDefault
  #12 = Utf8               SourceFile
  #13 = Utf8               MyCustomAnnotation.java
  #14 = Utf8               RuntimeVisibleAnnotations
  #15 = Utf8               Ljava/lang/annotation/Retention;
  #16 = Utf8               value
  #17 = Utf8               Ljava/lang/annotation/RetentionPolicy;
  #18 = Utf8               RUNTIME
{
  public abstract boolean someBooleanValueWithDefault();
    descriptor: ()Z
    flags: (0x0401) ACC_PUBLIC, ACC_ABSTRACT
    AnnotationDefault:
      default_value: Z#10
        true

  public abstract boolean someBooleanValueWithNoDefault();
    descriptor: ()Z
    flags: (0x0401) ACC_PUBLIC, ACC_ABSTRACT
}
SourceFile: "MyCustomAnnotation.java"
RuntimeVisibleAnnotations:
  0: #15(#16=e#17.#18)
    java.lang.annotation.Retention(
      value=Ljava/lang/annotation/RetentionPolicy;.RUNTIME
    )

$ javap -v build/classes/java/main/annotations/Example.class 
Classfile /Users/karuppiahn/oss/github.com/karuppiah7890/java-stuff/annotations/build/classes/java/main/annotations/Example.class
  Last modified Jul 13, 2020; size 387 bytes
  SHA-256 checksum 0c88bfe22094d6bccf2cdde4e8e489c87a9c9a0a27e85c2fcf701942d46ee55b
  Compiled from "Example.java"
public class annotations.Example
  minor version: 0
  major version: 58
  flags: (0x0021) ACC_PUBLIC, ACC_SUPER
  this_class: #7                          // annotations/Example
  super_class: #2                         // java/lang/Object
  interfaces: 0, fields: 0, methods: 1, attributes: 2
Constant pool:
   #1 = Methodref          #2.#3          // java/lang/Object."<init>":()V
   #2 = Class              #4             // java/lang/Object
   #3 = NameAndType        #5:#6          // "<init>":()V
   #4 = Utf8               java/lang/Object
   #5 = Utf8               <init>
   #6 = Utf8               ()V
   #7 = Class              #8             // annotations/Example
   #8 = Utf8               annotations/Example
   #9 = Utf8               Code
  #10 = Utf8               LineNumberTable
  #11 = Utf8               LocalVariableTable
  #12 = Utf8               this
  #13 = Utf8               Lannotations/Example;
  #14 = Utf8               SourceFile
  #15 = Utf8               Example.java
  #16 = Utf8               RuntimeVisibleAnnotations
  #17 = Utf8               Lannotations/MyCustomAnnotation;
  #18 = Utf8               someBooleanValueWithNoDefault
  #19 = Integer            0
{
  public annotations.Example();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: return
      LineNumberTable:
        line 4: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lannotations/Example;
}
SourceFile: "Example.java"
RuntimeVisibleAnnotations:
  0: #17(#18=Z#19)
    annotations.MyCustomAnnotation(
      someBooleanValueWithNoDefault=false
    )

```

Now you can see that it clearly says that there are "RuntimeVisibleAnnotations", and what
they are.

Apparently runtime retention policy is the most used when it comes to custom annotations.
It's available during runtime and can be read and processed. 

For `SOURCE` and `CLASS`, there are few uses I guess.

`SOURCE` - When you are writing some tools for an editor or writing a build tool
which reads the source code and does stuff, then this can be pretty useful, and the
annotations will not go into the .class files, and so they will not be polluted.

`CLASS` - This can be used when you need post compile processing, but not runtime.
For runtime, you would need `RUNTIME`. Post compile time means - after you generate
byte code. So yeah, tools that work on or process byte code could use annotations
that have this retention policy. 

---

Saw something about javac plugins or extensions or addons here

https://www.baeldung.com/java-build-compiler-plugin

While reading about annotations and java code processing
